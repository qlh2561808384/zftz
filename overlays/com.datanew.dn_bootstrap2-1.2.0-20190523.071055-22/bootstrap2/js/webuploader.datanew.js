(function(a){var b={init:function(n,h){var r=a(n),q=r.attr("id");r.append('<div class="queueList"></div><div class="statusBar" ><div class="progress"><span class="text">0%</span><span class="percentage"></span></div><div class="info"></div><div class="btns"><div class="filePicker2" id="webuploader_filePicker2_'+q+'"></div><div class="uploadBtn">开始上传</div></div></div>');var k=a('<ul class="filelist"></ul>').appendTo(r.find(".queueList")),w=r.find(".statusBar"),e=w.find(".info"),d=r.find(".uploadBtn"),i=r.find(".placeholder"),p=w.find(".progress").hide(),y=0,o=0,l=window.devicePixelRatio||1,m=150*l,c=150*l,j="pedding",z={},v=(function(){var A=document.createElement("p").style;var B="transition" in A||"WebkitTransition" in A||"MozTransition" in A||"msTransition" in A||"OTransition" in A;A=null;return B})(),t;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}h.swf="../plugins/webuploader/Uploader.swf",t=WebUploader.create(h);t.addButton({id:"#webuploader_filePicker2_"+q,label:"添加文件"});t.on("uploadAccept",function(B,A){h.uploadAccept.call(this,B,A)});function u(F){var G=a('<li id="'+F.id+'"><p class="title">'+F.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),D=a('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo(G),C=G.find("p.progress span"),B=G.find("p.imgWrap"),E=a('<p class="error"></p>'),A=function(H){switch(H){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}E.text(text).appendTo(G)};if(F.getStatus()==="invalid"){A(F.statusText)}else{B.text("预览中");t.makeThumb(F,function(J,K){if(J){var I=F.name;index=I.lastIndexOf(".");if(index!=-1){I=I.substring(index+1,I.length);var H=a('<img src="../images/webuploader_doc.png">');B.empty().append(H)}else{B.text("未知文件类型")}return}var H=a('<img src="'+K+'">');B.empty().append(H)},m,c);z[F.id]=[F.size,0];F.rotation=0}F.on("statuschange",function(I,H){if(H==="progress"){C.hide().width(0)}else{if(H==="queued"){G.off("mouseenter mouseleave");D.remove()}}if(I==="error"||I==="invalid"){A(F.statusText);z[F.id][1]=1}else{if(I==="interrupt"){A("interrupt")}else{if(I==="queued"){z[F.id][1]=0}else{if(I==="progress"){E.remove();C.css("display","block")}else{if(I==="complete"){G.append('<span class="success"></span>')}}}}}G.removeClass("state-"+H).addClass("state-"+I)});G.on("mouseenter",function(){D.stop().animate({height:30})});G.on("mouseleave",function(){D.stop().animate({height:0})});D.on("click","span",function(){var H=a(this).index(),I;switch(H){case 0:t.removeFile(F);return;case 1:F.rotation+=90;break;case 2:F.rotation-=90;break}if(v){I="rotate("+F.rotation+"deg)";B.css({"-webkit-transform":I,"-mos-transform":I,"-o-transform":I,transform:I})}else{B.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((F.rotation/90)%4+4)%4)+")")}});G.appendTo(k)}function x(A){var B=a("#"+A.id);delete z[A.id];f();B.off().find(".file-panel").off().end().remove()}function f(){var A=0,D=0,B=p.children(),C;a.each(z,function(F,E){D+=E[0];A+=E[0]*E[1]});C=D?A/D:0;B.eq(0).text(Math.round(C*100)+"%");B.eq(1).css("width",Math.round(C*100)+"%");g()}function g(){var B="",A;if(j==="ready"){B="选中"+y+"个文件，共"+WebUploader.formatSize(o)+"。"}else{if(j==="confirm"){A=t.getStats();if(A.uploadFailNum){B="已成功上传"+A.successNum+"个文件，"+A.uploadFailNum+'个文件上传失败，<a class="retry" href="#">重新上传</a>或<a class="ignore" href="#">忽略</a>'}}else{A=t.getStats();B="共"+y+"文件（"+WebUploader.formatSize(o)+"），已上传"+A.successNum+"文件";if(A.uploadFailNum){B+="，失败"+A.uploadFailNum+"文件"}}}e.html(B)}function s(C){var B,A;if(C===j){return}d.removeClass("state-"+j);d.addClass("state-"+C);j=C;switch(j){case"pedding":i.removeClass("element-invisible");k.parent().removeClass("filled");t.refresh();break;case"ready":i.addClass("element-invisible");a(".filePicker2").removeClass("element-invisible");k.parent().addClass("filled");k.show();t.refresh();break;case"uploading":a(".filePicker2").addClass("element-invisible");p.show();d.text("暂停上传");break;case"paused":p.show();d.text("继续上传");break;case"confirm":p.hide();d.text("开始上传").addClass("disabled");A=t.getStats();if(A.successNum&&!A.uploadFailNum){s("finish");return}break;case"finish":A=t.getStats();if(A.successNum){}else{j="done";location.reload()}break}g()}t.onUploadProgress=function(C,A){var D=a("#"+C.id),B=D.find(".progress span");B.css("width",A*100+"%");z[C.id][1]=A;f()};t.onFileQueued=function(A){y++;o+=A.size;if(y===1){i.addClass("element-invisible");w.show()}u(A);s("ready");f()};t.onFileDequeued=function(A){y--;o-=A.size;if(!y){s("pedding")}x(A);f()};t.on("all",function(B){var A;switch(B){case"uploadFinished":s("confirm");break;case"startUpload":s("uploading");break;case"stopUpload":s("paused");break}});t.onError=function(A){};d.on("click",function(){if(a(this).hasClass("disabled")){return false}if(j==="ready"){t.upload()}else{if(j==="paused"){t.upload()}else{if(j==="uploading"){t.stop()}}}});e.on("click",".retry",function(){t.retry()});e.on("click",".ignore",function(){if(h.onIgnore){h.onIgnore(this,t)}});d.addClass("state-"+j);f();return t}};a.fn.weblupload=function(c){var e=a(this),d;if(typeof c=="object"){a.include(["bootstrap/plugins/webuploader/webuploader.js","bootstrap/plugins/webuploader/webuploader.css"]);return b.init(this,c)}}})(jQuery);