function supportstorage(){if(typeof window.localStorage=="object"){return true}else{return false}}var dragConfig=[];function handleSaveLayout(){var a=$(".main").html();if(!stopsave&&a!=window.mainHtml){stopsave++;window.mainHtml=a;saveLayout();stopsave--}}var layouthistory;function saveLayout(){var b=layouthistory;var a=$("#sideTree").tree("getTree").setting.localdata;if(!b){b={};b.count=0;b.list=[]}if(b.list.length>b.count){for(i=b.count;i<b.list.length;i++){b.list[i]=null}}b.list[b.count]=window.mainHtml;b.count++;if(supportstorage()){localStorage.setItem("layoutdata",JSON.stringify(b));localStorage.setItem("$localData",JSON.stringify(a))}layouthistory=b}function downloadLayout(){$.ajax({type:"POST",url:"/build/downloadLayout",data:{layout:$("#download-layout").html()},success:function(a){window.location.href="/build/download"}})}function downloadHtmlLayout(){$.ajax({type:"POST",url:"/build/downloadLayout",data:{layout:$("#download-layout").html()},success:function(a){window.location.href="/build/downloadHtml"}})}function undoLayout(){var a=layouthistory;if(a){if(a.count<2){return false}window.mainHtml=a.list[a.count-2];a.count--;$(".main").html(window.mainHtml);if(supportstorage()){localStorage.setItem("layoutdata",JSON.stringify(a));localStorage.setItem("$localData",JSON.stringify(a))}return true}return false}function redoLayout(){var a=layouthistory;if(a){if(a.list[a.count]){window.mainHtml=a.list[a.count];a.count++;$(".main").html(window.mainHtml);if(supportstorage()){localStorage.setItem("layoutdata",JSON.stringify(a));localStorage.setItem("$localData",JSON.stringify(a))}return true}}return false}function handleJsIds(){handlePlugIds();handleModalIds();handleAccordionIds();handleCarouselIds();handleTabsIds()}var zNodes=[{id:1,pId:0,name:"节点搜索演示 1",open:true,ISLEAF:0},{id:11,pId:1,name:"关键字可以是名字",ISLEAF:1},{id:14,pId:1,name:"关键字可以是各种属性",ISLEAF:1},{id:2,pId:0,name:"节点搜索演示 2",open:true,ISLEAF:0},{id:21,pId:2,name:"可以只搜索一个节点",ISLEAF:1},{id:22,pId:2,name:"可以搜索节点集合",ISLEAF:1},{id:23,pId:2,name:"搜我吧",ISLEAF:1}],comboBoxData=[{id:1,text:"value 1"},{id:2,text:"value 2"},{id:3,text:"value 3"}],formInputs=[{title:"姓名",name:"uname",type:"textBox"},{title:"性别",name:"usex",type:"comboBox",localdata:[{id:1,text:"男"},{id:2,text:"女"}]}],buttonInputs={text:"按钮",icon:"",size:"",type:"",handler:function(){}},webuploaderInputs={isDel:true,isDownload:true,server:"../plugins/webuploader/webuploader.json",dataUrl:"../plugins/webuploader/filesList.json",delUrl:"../plugins/webuploader/webuploader.json",downloadUrl:"../plugins/webuploader/webuploader.json",onLoaded:function(a){}};tableCol=[{field:"status",title:"状态",width:100,align:"center"},{field:"account",title:"代收机构",width:100,align:"center"},{field:"accountname",title:"接入应用",width:100,align:"center"},{field:"writeusername",title:"支付方式",width:150,align:"center"}],tableData=[{status:1,account:"1",accountname:"账户1",writeusername:"姓名1"},{status:2,account:"2",accountname:"账户2",writeusername:"姓名2"},{status:3,account:"3",accountname:"账户3",writeusername:"姓名3"}];var searchbar=[{rownum:3,inputs:[{title:"姓名",name:"name",type:"textBox",placeholder:"输入姓名"},{title:"test",name:"test",type:"comboBox",localdata:[{guid:1,postaccount:"test"}],valueField:"guid",textField:"postaccount",searchOption:true},{type:"searchTree",title:"ceshi",name:"searchtree",localdata:zNodes,ISLEAF:false,modalTitle:"查找名称",checkType:"checkbox"}]}];var searchbar=JSON.stringify(searchbar);var zNodesStr=JSON.stringify(zNodes),comboBoxDataStr=JSON.stringify(comboBoxData),formInputsStr=JSON.stringify(formInputs),tableColStr=JSON.stringify(tableCol),tableDataStr=JSON.stringify(tableData);var defaultTreeData="./example/json/treeData.json";var dragAll=[];function handlePlugIds(c,a){var d=$(".main").find("#"+c);var b=a+"-"+randomNumber();d.attr("id",b);if(a.toLowerCase().indexOf("tree")!==-1){d[a]({url:defaultTreeData})}else{if(a==="comboBox"){d[a]({localdata:comboBoxData})}else{if(a==="dtable"){d[a]({columns:tableCol,data:tableData})}else{if(a==="decimal"){d[a]({decimalPlaces:2})}else{if(a==="html"){}else{if(a==="dform"){d[a]({inputs:formInputs})}else{if(a==="dbutton"){d[a](buttonInputs)}else{if(a==="webupload"){d[a](webuploaderInputs)}else{d[a]({})}}}}}}}}}function handleAccordionIds(){var c=$(".main #accordion");var a=randomNumber();var d="panel-"+a;var b;c.attr("id",d);c.find(".panel").each(function(g,f){b="collapse-"+randomNumber();$(f).find(".panel-title a").each(function(j,h){$(h).attr("data-parent","#"+d);$(h).attr("href","#"+b)});$(f).find(".panel-collapse").each(function(j,h){$(h).attr("id",b)})})}function handleCarouselIds(){var b=$(".main #myCarousel");var a=randomNumber();var c="carousel-"+a;b.attr("id",c);b.find(".carousel-indicators li").each(function(f,d){$(d).attr("data-target","#"+c)});b.find(".left").attr("href","#"+c);b.find(".right").attr("href","#"+c)}function handleModalIds(){var c=$(".main #myModalLink");var a=randomNumber();var d="modal-container-"+a;var b="modal-"+a;c.attr("id",b);c.attr("data-target","#"+d);c.next().attr("id",d)}function handleTabsIds(){var b=$(".main #myTabs");var a=randomNumber();var c="tabs-"+a;b.attr("id",c);b.parent().find(".tab-pane").each(function(g,d){var h=$(d).attr("id");var f="panel-"+randomNumber();$(d).attr("id",f);$(d).parent().parent().find("a[href=#"+h+"]").attr("href","#"+f)})}function randomNumber(){return randomFromInterval(1,1000000)}function randomFromInterval(b,a){return Math.floor(Math.random()*(a-b+1)+b)}function gridSystemGenerator(){$(".lyrow .preview input").bind("keyup",function(){var b=0;var a="";var c=$(this).val().split(" ",12);$.each(c,function(e,d){b=b+parseInt(d);a+='<div class="col-sm-'+d+' column layoutClass"></div>'});if(b==12){$(this).parent().next().children().html(a);$(this).parent().prevAll(".drag").show()}else{$(this).parent().prevAll(".drag").hide()}})}function configurationElm(b,a){$(".main").delegate(".configuration > a","click",function(d){d.preventDefault();var c=$(this).parent().next().next().children();$(this).toggleClass("active");c.toggleClass($(this).attr("rel"))});$(".main").delegate(".configuration .dropdown-menu a","click",function(f){f.preventDefault();var c=$(this).parent().parent();var g=c.parent().parent().next().next().children();c.find("li").removeClass("active");$(this).parent().addClass("active");var d="";c.find("a").each(function(){d+=$(this).attr("rel")+" "});c.parent().removeClass("open");g.removeClass(d);g.addClass($(this).attr("rel"))})}function removeElm(){$(".main").delegate(".remove","click",function(d){d.preventDefault();var b=$(this).siblings(".view").find("[dtype]").attr("id");$(this).parent().remove();if(!$(".main .lyrow").length>0){clearMain()}var c=$("#optionsForm").attr("did");if(c==b){$(".setOptionsForm").hide()}a(b);function a(h){if(h){var f=$("#sideTree").tree("getTree").setting.localdata;for(var e=0;e<f.length;e++){if(f[e].dragId==h){f.splice(e,1)}}}else{var f=""}downloadLayout_clean();var g="layoutClass";$("#sideTree").empty().tree({localdata:f,checkType:"nocheck",data:{key:{children:"plug",name:"dragName"},simpleData:{idKey:"dragId",pIdKey:"dragPId"}},onLoaded:function(j){j.expandAll(true)}});$("#sideTree li a").each(function(j){$(this).on("click",function(){if(j==0){$(".main").addClass("layout_tree_focus");$(".main").find("."+g).removeClass("layout_tree_focus")}else{$(".main").removeClass("layout_tree_focus");$(".main").find("."+g).removeClass("layout_tree_focus").eq(j-1).addClass("layout_tree_focus")}})});$(".main").find("."+g).removeClass("layout_tree_focus")}})}function clearMain(){$(".main").empty();layouthistory=null;if(supportstorage()){localStorage.removeItem("layoutdata")}localStorage.removeItem("$localData")}function changeStructure(b,a){$("#download-layout ."+b).removeClass(b).addClass(a)}function cleanHtml(a){$(a).parent().append($(a).children().html())}function downloadLayout_clean(){var b="";$("#download-layout").children().html($(".main").html());var a=$("#download-layout").children();a.find(".preview, .configuration, .drag, .remove").remove();a.find(".lyrow").addClass("removeClean");a.find(".box-element").addClass("removeClean");a.find(".lyrow .lyrow .lyrow .lyrow .lyrow .removeClean").each(function(){cleanHtml(this)});a.find(".lyrow .lyrow .lyrow .lyrow .removeClean").each(function(){cleanHtml(this)});a.find(".lyrow .lyrow .lyrow .removeClean").each(function(){cleanHtml(this)});a.find(".lyrow .lyrow .removeClean").each(function(){cleanHtml(this)});a.find(".lyrow .removeClean").each(function(){cleanHtml(this)});a.find(".removeClean").each(function(){cleanHtml(this)});a.find(".removeClean").remove();$("#download-layout .column").removeClass("ui-sortable");$("#download-layout .row-fluid").removeClass("clearfix").children().removeClass("column");if($("#download-layout .container").length>0){changeStructure("row-fluid","row")}}function downloadLayoutSrc(){var e=$("#download-layout").children();formatSrc=$.htmlClean($("#download-layout").html(),{format:true,allowedAttributes:[["id"],["class"],["dtype"],["data-toggle"],["data-target"],["data-parent"],["role"],["data-dismiss"],["aria-labelledby"],["aria-hidden"],["data-slide-to"],["data-slide"]]});$("#download-layout").html(formatSrc);var b=$("#sideTree").tree("getTree").getNodes();var a=cloneObj(b);initProcessForm(a);var f=process(a);delJson(f,"isHover");delJson(f,"dragId");var d=function(h,g){if(typeof g==="function"){return Function.prototype.toString.call(g)}return g};var c=JSON.stringify(f,d,4);$("#downloadModal textarea:eq(0)").val(c)}function createTree(n,d){downloadLayout_clean();var h=$(".main");var a=[];var g=[];var p="layoutClass";var b=[];h.find("."+p).each(function(j){if($(this).hasClass("row-fluid row")){var s=$(this).parent().prev(".preview");var r;if($(this).get(0).tagName.toLowerCase()==="form"){r="form"}else{r=$.trim(s.find("input").val())}g=$.trim(s.find("input").val()).split(" ");a[j]=r+"布局面板"}else{if($(this).hasClass("column")){var q=$(this).index();a[j]=g[q]+"子面板";b[j]=g[q]}else{var s=$(this).parents(".box").find(".preview");a[j]=s.text()}}});var c=$("#download-layout");var m=[{dragTag:c.children().get(0).tagName.toLowerCase(),dragClass:c.children().attr("class"),dragId:p+"_0",dragPId:"0",dragName:"container",dragAll:{dtype:"body"}}];var f=c.find("."+p);if(f.length>0){var o=Array.prototype.slice.call(arguments,0);var e=o.length>0?$("#sideTree").tree("getTree").setting.localdata:JSON.parse(localStorage.getItem("$localData"));$.each(f,function(q){if($(this).parent().is(".fixed-table-header")){return true}if(!$(this).attr("id")){$(this).attr("id",p+"_"+(q+1))}var t;if($(this).parents("."+p).length==0){t=m[0].dragId}else{t=$(this).parents("."+p).eq(0).attr("id")}var j=$(this).attr("dtype")==null?"html":$(this).attr("dtype");var r={dragId:$(this).attr("id"),dragPId:t,dragName:a[q],dragTag:$(this).get(0).tagName.toLowerCase(),dragClass:$(this).attr("class"),dragAll:{colspan:b[q],dtype:j}};if(j==="html"){var s=$(this).prop("outerHTML");s=s.replace(/\r\n/g,"");s=s.replace(/\n/g,"");s=$.trim(s);r.dragAll.dragHtml=s}if(j.toLowerCase().indexOf("tree")!==-1){r.dragAll.url=defaultTreeData}else{if(j==="dtable"){r.dragAll.columns=tableCol;r.dragAll.data=tableData}else{if(j==="comboBox"){r.dragAll.localdata=comboBoxData}else{if(j==="dform"){r.dragAll.inputs=formInputs}}}}m.push(r)})}if(e){if(o.length>0){for(var l=0;l<m.length;l++){for(var k=0;k<e.length;k++){if(e[k].dragId===m[l].dragId){m[l].dragAll=e[k].dragAll}}}}else{m=e}}$("#sideTree").empty().tree({localdata:m,checkType:"nocheck",data:{key:{children:"plug",name:"dragName"},simpleData:{idKey:"dragId",pIdKey:"dragPId"}},onLoaded:function(j){j.expandAll(true)}});$("#sideTree li a").each(function(j){$(this).on("click",function(){if(j==0){$(".main").addClass("layout_tree_focus");$(".main").find("."+p).removeClass("layout_tree_focus")}else{$(".main").removeClass("layout_tree_focus");var q=$(".main").find("."+p).removeClass("layout_tree_focus").eq(j-1);var r=$(".main").find("."+p);var u=r.length;for(var s=0;s<u;s++){if($(r[s]).attr("dtype")==undefined){r.splice(s,1);u--}}if(q.attr("dtype")!="column"&&q.attr("dtype")!="row"&&q.attr("dtype")!="container"){var v=$(r.eq(j-1).parents(".view")[0]).siblings(".configuration").find("button");openOptions(v)}else{$(".setOptionsForm").hide()}r.removeClass("layout_tree_focus").eq(j-1).addClass("layout_tree_focus")}})});$(".main").find("."+p).removeClass("layout_tree_focus")}function process(a){$.each(a,function(){for(var b in this){if(!(b=="plug"||b=="dragAll"||b=="dragId")){delete this[b]}}});$.each(a,function(){for(var e in this){var c=this;if(e=="plug"){process(this[e])}if(e=="dragAll"){var b=this[e];for(var d in b){this[d]=b[d]}delete this[e]}}});return a}function processForm(b){var a=[];$.each(b,function(d,e){for(var c in this){if(c=="dragAll"){delete e[c]}else{if(c=="plug"&&e[c]!=null){$.each(e[c][0],function(f,g){if(f=="dragAll"){a.push(g)}})}}}});return a}function initProcessForm(a){$.each(a,function(c,d){for(var b in this){if(b=="plug"&&this[b].plug!=undefined){processForm(this[b])}if(b=="dtype"&&this[b]=="dform"){}}})}function delJson(b,a){$.each(b,function(){for(var c in this){if(c==a){delete this[c]}if(c=="plug"){delJson(this[c],a)}}})}var currentDocument=null;var timerSave=1000;var stopsave=0;var startdrag=0;var mainHtml=$(".main").html();var currenteditor=null;$(window).resize(function(){$("body").css("min-height",$(window).height()-90);$(".main").css("min-height",$(window).height()-160)});function restoreData(){if(supportstorage()){layouthistory=JSON.parse(localStorage.getItem("layoutdata"));var e=JSON.parse(localStorage.getItem("$localData"));if(!layouthistory){return false}window.mainHtml=layouthistory.list[layouthistory.count-1];if(window.mainHtml){$(".main").html(window.mainHtml);var j=$(".main .view");var g=[],f=[];for(var h=0;h<j.length;h++){if($(j[h]).siblings(".configuration").length>0){g.push($(j[h]))}}if(e){for(var d=0;d<e.length;d++){var b=e[d].dragId;if(b.indexOf("layoutClass_")==-1){f.push(e[d])}}for(var c=0;c<g.length;c++){var a="#"+f[c].dragId;g[c].empty().append("<input class='layoutClass'id="+f[c].dragId+' dtype="'+f[c].dragAll.dtype+'">');$(a)[f[c].dragAll.dtype](f[c].dragAll)}}}}}function initContainer(){$(".main, .main .column").sortable({connectWith:".column",opacity:0.35,handle:".drag",start:function(b,a){if(!startdrag){stopsave++}startdrag=1},stop:function(b,a){if(stopsave>0){stopsave--}startdrag=0;createTree(a.item)}});configurationElm()}$(document).ready(function(){$("#menu-layoutit li button").click(function(){$("#menu-layoutit li button").removeClass("active");$(this).addClass("active")});$(".sideTreeOver").css({"overflow-y":"scroll",height:$(".sidebar-nav").height()/2,});CKEDITOR.disableAutoInline=true;restoreData();var a=CKEDITOR.replace("contenteditor",{language:"zh-cn",cloudServices_tokenUrl:"./",cloudServices_uploadUrl:"./",allowedContent:true});$("body").css("min-height",$(window).height()-90);$(".overBox").css({height:$(window).height()/2,"overflow-y":"scroll"});$(".setOptionsForm").css({"margin-top":"10px","margin-left":"220px",height:$(window).height()/2-100,"overflow-y":"scroll",background:"#cccccc"});$(".main").css({"min-height":$(window).height()/2,overflow:"hidden"});createTree();$(".sidebar-nav .lyrow").draggable({connectToSortable:".main",helper:"clone",handle:".drag",start:function(c,b){if(!startdrag){stopsave++}startdrag=1},drag:function(c,b){b.helper.width(400)},stop:function(f,b){var d=$(f.target).attr("class");if(d.indexOf("formrow")!=-1){var c=$(".main").find("[dtype='dform']");var g="dform-"+randomNumber();$.each(c,function(){$(this).attr("id",g)})}$(".main .column").sortable({opacity:0.35,connectWith:".column",start:function(j,h){if(!startdrag){stopsave++}startdrag=1},stop:function(j,h){if(stopsave>0){stopsave--}startdrag=0;createTree(h.item)}});initContainer();if(stopsave>0){stopsave--}startdrag=0;createTree(b.item)}});$(".sidebar-nav .box").draggable({connectToSortable:".column",helper:"clone",handle:".drag",start:function(c,b){if(!startdrag){stopsave++}startdrag=1},drag:function(c,b){b.helper.width(400)},stop:function(f,c){var d=$(this).find(".layoutClass").attr("id");var b=$(this).find(".layoutClass").attr("dtype")==null?"html":$(this).find(".layoutClass").attr("dtype");handlePlugIds(d,b);if(stopsave>0){stopsave--}startdrag=0;createTree(c,d)}});initContainer();$("body.edit .main").on("click","[data-target=#editorModal]",function(c){c.preventDefault();currenteditor=$(this).parent().parent().find(".view");var b=currenteditor.html();a.setData(b)});$("#savecontent").click(function(b){b.preventDefault();currenteditor.html(a.getData())});$("[data-target=#downloadModal]").click(function(b){b.preventDefault();downloadLayoutSrc()});$("[data-target=#shareModal]").click(function(b){b.preventDefault();handleSaveLayout()});$("#download").click(function(){downloadLayout();return false});$("#downloadhtml").click(function(){downloadHtmlLayout();return false});$("#edit").click(function(){$("body").removeClass("devpreview sourcepreview");$("body").addClass("edit");$(".overBox").css({height:$(window).height()/2,"overflow-y":"scroll"});$(".mainContent").addClass("margin");$(".setOptionsForm").hide();return false});$("#clear").click(function(b){b.preventDefault();clearMain();createTree()});$("#devpreview").click(function(){$("body").removeClass("edit sourcepreview");$("body").addClass("devpreview");$(".overBox").attr("style","");$(".mainContent").removeClass("margin");$(".setOptionsForm").hide();return false});$("#sourcepreview").click(function(){$("body").removeClass("edit");$("body").addClass("devpreview sourcepreview");$(".mainContent").removeClass("margin");$(".overBox").attr("style","");$(".setOptionsForm").hide();return false});$("#fluidPage").click(function(b){b.preventDefault();changeStructure("container","container-fluid");$(this).addClass("active").siblings().removeClass("active");downloadLayoutSrc()});$("#fixedPage").click(function(b){b.preventDefault();changeStructure("container-fluid","container");$(this).addClass("active").siblings().removeClass("active");downloadLayoutSrc()});$(".nav-header").click(function(){$(".sidebar-nav .boxes, .sidebar-nav .rows").hide();$(this).next().slideDown()});$("#undo").click(function(){stopsave++;if(undoLayout()){initContainer()}stopsave--;createTree()});$("#redo").click(function(){stopsave++;if(redoLayout()){initContainer()}stopsave--;createTree()});removeElm();gridSystemGenerator();setInterval(function(){handleSaveLayout()},timerSave)});