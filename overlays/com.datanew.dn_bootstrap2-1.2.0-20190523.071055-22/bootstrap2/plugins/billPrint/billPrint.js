var BillPrint=function(b,a){this.options=a;this.target=$(b);this.nodesArea;this.bgImg;this.areaWidth;this.areaHeight;this.init()};BillPrint.DEFAULTS={bgUrl:"",edit:true,defaultValue:""};BillPrint.prototype.init=function(){var c=this,a=c.target,b=c.options;var d='<div class="bg noPrint printArea"><img src="'+b.bgUrl+'" class="bgImg"></div><div class="nodesArea printArea"></div>';a.addClass("printWrap editPage").html(d);c.nodesArea=a.find(".nodesArea");c.bgImg=a.find(".bgImg");c.setHeight();if(b.defaultValue!==""){c.previewPage({preContent:b.defaultValue});if(b.edit){c.editPage()}}};BillPrint.prototype.setHeight=function(){var b=this,a=b.target,c=b.nodesArea,e=b.bgImg;var d=setInterval(function(){if(e.outerWidth()>0&&e.outerHeight()>0){b.areaWidth=e.outerWidth();b.areaHeight=e.outerHeight();a.width(b.areaWidth).height(b.areaHeight);c.width(b.areaWidth).height(b.areaHeight).css({position:"absolute"});clearInterval(d)}},100)};BillPrint.prototype.changeBg=function(a){this.target.find(".bgImg").attr("src",a);this.setHeight()};BillPrint.prototype.doPrint=function(){this.target.print()};BillPrint.prototype.addTxtNode=function(j){if(this.target.hasClass("showPage")){layer.msg("预览状态不可编辑",{time:1000});return}var h=this,d=h.target,a=h.nodesArea,b=d.find(".txtNode").length+1,g="txtNode"+b+"_txt",i,e=$('<div class="txtNode"><div class="txt_editBtn"><a class="btn dragBtn">拖拽</a><a class="btn delBtn">删除</a></div><div class="txt_font"></div><div class="resizeBtn"></div></div>'),k={text:"新增",width:150,height:30,left:30,top:30};j=$.extend({},k,j);e.css({position:"absolute",left:j.left,top:j.top}).width(j.width).height(j.height).find(".txt_font").html(j.text);a.append(e);var c=[["Bold","Italic","Underline","Strike","Subscript","Superscript"],["NumberedList","BulletedList","-","Outdent","Indent"],["JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock"],["Link","Unlink","Anchor"],["Image","Flash","Table","HorizontalRule","Smiley","SpecialChar","PageBreak"],"/",["Styles","Format","Font","FontSize"],["TextColor","BGColor"],["Maximize","ShowBlocks","-"]],f=j.toolbar===undefined?c:j.toolbar;d.find(".txtNode").last().find(".txt_font").attr({contenteditable:"true",id:g}).on("focus",function(){if(!CKEDITOR.instances[g]){CKEDITOR.disableAutoInline=true;i=CKEDITOR.inline(g,{toolbar:f})}}).on("blur",function(){});h.dragNode()};BillPrint.prototype.dragNode=function(){var b=this,a=b.target;a.on("click",".delBtn",function(){$(this).parents(".txtNode").remove()});$("body").on("mousedown",".dragBtn",function(d){var g=$(this).parents(".txtNode").get(0);var f=$(this).offset();var c=$(g).position();g.posix={x:d.pageX-c.left,y:d.pageY-c.top};$.extend(document,{move:true,move_target:g})}).on("mousedown",".resizeBtn",function(d){var f=$(this).parents(".txtNode");var c={w:f.width(),h:f.height(),x:d.pageX,y:d.pageY};$.extend(document,{move:true,call_down:function(g){f.css({width:Math.max(30,g.pageX-c.x+c.w),height:Math.max(30,g.pageY-c.y+c.h)});if(f.height()<=45){f.find(".txt_font").addClass("text-ell")}else{f.find(".txt_font").removeClass("text-ell")}}});return false});$(document).mousemove(function(d){if(!!this.move){var c=!document.move_target?{x:0,y:0}:document.move_target.posix,f=document.call_down||function(){$(this.move_target).css({top:d.pageY-c.y,left:d.pageX-c.x})};f.call(this,d,c)}}).mouseup(function(c){if(!!this.move){var d=document.call_up||function(){};d.call(this,c);$.extend(this,{move:false,move_target:null,call_down:false,call_up:false})}})};BillPrint.prototype.getValue=function(){var c=this,b=c.target.clone(),a="";b.removeClass("editPage showPage");$.each(b.find(".txt_font"),function(){var d=$(this),f=$.extend({},this.attributes);for(var g=0;g<f.length;g++){var e=f[g].nodeName,j=f[g].nodeValue;if(e==="class"){var h=j.split(" ");$.each(h,function(i){if(h[i].indexOf("cke_")===0){d.removeClass(h[i])}})}else{if(e!=="id"){d.removeAttr(e)}}}});a=b.prop("outerHTML");return a};BillPrint.prototype.getPage=function(){this.getValue()};BillPrint.prototype.getBg=function(){return this.bgImg.attr("src")};BillPrint.prototype.setValue=function(e){if(e==undefined){return false}var g=this,k=g.options,b=g.target,h=k.id?k.id:(b.attr("id")?b.attr("id"):"");if(e.preContent&&e.preContent!==""){var d=$(e.preContent),j=d.get(0).attributes;for(var f=0;f<j.length;f++){var a=j[f].nodeName,c=j[f].nodeValue;if(a==="class"){b.addClass(c)}else{if(a==="id"&&h){b.attr(a,h)}else{b.attr(a,c)}}}b.html(d.html())}g.nodesArea=b.find(".nodesArea");g.bgImg=b.find(".bgImg");if(e.preBgUrl!==undefined){g.changeBg(e.preBgUrl)}g.setHeight();g.readonly()};BillPrint.prototype.previewPage=function(a){this.setValue(a)};BillPrint.prototype.readonly=function(){var a=this.target;a.removeClass("editPage").addClass("showPage").find(".txt_font").removeAttr("contenteditable").removeAttr("tabindex").removeAttr("data-cke-expando")};BillPrint.prototype.setReadonly=function(a){if(a){this.readonly()}else{this.editPage()}};BillPrint.prototype.setDisabled=function(a){if(a){this.readonly()}else{this.editPage()}};BillPrint.prototype.editPage=function(){var a=this.target;a.removeClass("showPage").addClass("editPage").find(".txt_font").attr({contenteditable:"true",tabindex:"0","data-cke-expando":"32"});this.dragNode()};BillPrint.prototype.clear=function(){this.nodesArea.height("auto").find(".txtNode").remove();this.bgImg.attr("src","");this.target.height("auto")};BillPrint.prototype.validate=function(){return true};BillPrint.prototype.destroy=function(){this.target.remove()};