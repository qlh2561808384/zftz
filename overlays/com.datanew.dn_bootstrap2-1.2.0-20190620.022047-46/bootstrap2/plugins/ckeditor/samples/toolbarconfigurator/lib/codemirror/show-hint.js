(function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)})(function(e){function g(j,f){this.cm=j;this.options=this.buildOptions(f);this.widget=null;this.tick=this.debounce=0;this.startPos=this.cm.getCursor();this.startLen=this.cm.getLine(this.startPos.line).length;var k=this;j.on("cursorActivity",this.activityFunc=function(){k.cursorActivity()})}function b(k,j){function p(f,r){var q;q="string"!=typeof r?function(s){return r(s,j)}:n.hasOwnProperty(r)?n[r]:r;m[f]=q}var n={Up:function(){j.moveFocus(-1)},Down:function(){j.moveFocus(1)},PageUp:function(){j.moveFocus(-j.menuSize()+1,!0)},PageDown:function(){j.moveFocus(j.menuSize()-1,!0)},Home:function(){j.setFocus(0)},End:function(){j.setFocus(j.length-1)},Enter:j.pick,Tab:j.pick,Esc:j.close},o=k.options.customKeys,m=o?{}:n;if(o){for(var l in o){o.hasOwnProperty(l)&&p(l,o[l])}}if(o=k.options.extraKeys){for(l in o){o.hasOwnProperty(l)&&p(l,o[l])}}return m}function c(j,f){for(;f&&f!=j;){if("LI"===f.nodeName.toUpperCase()&&f.parentNode==j){return f}f=f.parentNode}}function i(E,D){this.completion=E;this.data=D;this.picked=!1;var C=this,A=E.cm,B=this.hints=document.createElement("ul");B.className="CodeMirror-hints";this.selectedHint=D.selectedHint||0;for(var v=D.list,z=0;z<v.length;++z){var w=B.appendChild(document.createElement("li")),y=v[z],x="CodeMirror-hint"+(z!=this.selectedHint?"":" CodeMirror-hint-active");null!=y.className&&(x=y.className+" "+x);w.className=x;y.render?y.render(w,D,y):w.appendChild(document.createTextNode(y.displayText||("string"==typeof y?y:y.text)));w.hintId=z}var z=A.cursorCoords(E.options.alignWithWord?D.from:null),f=z.left,G=z.bottom,s=!0;B.style.left=f+"px";B.style.top=G+"px";w=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);x=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(E.options.container||document.body).appendChild(B);y=B.getBoundingClientRect();if(0<y.bottom-x){var F=y.bottom-y.top;0<z.top-(z.bottom-y.top)-F?(B.style.top=(G=z.top-F)+"px",s=!1):F>x&&(B.style.height=x-5+"px",B.style.top=(G=z.bottom-y.top)+"px",x=A.getCursor(),D.from.ch!=x.ch&&(z=A.cursorCoords(x),B.style.left=(f=z.left)+"px",y=B.getBoundingClientRect()))}x=y.right-w;0<x&&(y.right-y.left>w&&(B.style.width=w-5+"px",x-=y.right-y.left-w),B.style.left=(f=z.left-x)+"px");A.addKeyMap(this.keyMap=b(E,{moveFocus:function(l,k){C.changeActive(C.selectedHint+l,k)},setFocus:function(k){C.changeActive(k)},menuSize:function(){return C.screenAmount()},length:v.length,close:function(){E.close()},pick:function(){C.pick()},data:D}));if(E.options.closeOnUnfocus){var o;A.on("blur",this.onBlur=function(){o=setTimeout(function(){E.close()},100)});A.on("focus",this.onFocus=function(){clearTimeout(o)})}var j=A.getScrollInfo();A.on("scroll",this.onScroll=function(){var n=A.getScrollInfo(),k=A.getWrapperElement().getBoundingClientRect(),m=G+j.top-n.top,l=m-(window.pageYOffset||(document.documentElement||document.body).scrollTop);s||(l+=B.offsetHeight);if(l<=k.top||l>=k.bottom){return E.close()}B.style.top=m+"px";B.style.left=f+j.left-n.left+"px"});e.on(B,"dblclick",function(k){(k=c(B,k.target||k.srcElement))&&null!=k.hintId&&(C.changeActive(k.hintId),C.pick())});e.on(B,"click",function(k){(k=c(B,k.target||k.srcElement))&&null!=k.hintId&&(C.changeActive(k.hintId),E.options.completeOnSingleClick&&C.pick())});e.on(B,"mousedown",function(){setTimeout(function(){A.focus()},20)});e.signal(D,"select",v[0],B.firstChild);return !0}e.showHint=function(j,f,l){if(!f){return j.showHint(l)}l&&l.async&&(f.async=!0);f={hint:f};if(l){for(var k in l){f[k]=l[k]}}return j.showHint(f)};e.defineExtension("showHint",function(f){1<this.listSelections().length||this.somethingSelected()||(this.state.completionActive&&this.state.completionActive.close(),f=this.state.completionActive=new g(this,f),f.options.hint&&(e.signal(this,"startCompletion",this),f.update()))});var a=window.requestAnimationFrame||function(f){return setTimeout(f,1000/60)},h=window.cancelAnimationFrame||clearTimeout;g.prototype={close:function(){this.active()&&(this.tick=this.cm.state.completionActive=null,this.cm.off("cursorActivity",this.activityFunc),this.widget&&this.widget.close(),e.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(j,f){var k=j.list[f];k.hint?k.hint(this.cm,j,k):this.cm.replaceRange("string"==typeof k?k:k.text,k.from||j.from,k.to||j.to,"complete");e.signal(j,"pick",k);this.close()},showHints:function(f){if(!f||!f.list.length||!this.active()){return this.close()}this.options.completeSingle&&1==f.list.length?this.pick(f,0):this.showWidget(f)},cursorActivity:function(){this.debounce&&(h(this.debounce),this.debounce=0);var j=this.cm.getCursor(),f=this.cm.getLine(j.line);if(j.line!=this.startPos.line||f.length-j.ch!=this.startLen-this.startPos.ch||j.ch<this.startPos.ch||this.cm.somethingSelected()||j.ch&&this.options.closeCharacters.test(f.charAt(j.ch-1))){this.close()}else{var k=this;this.debounce=a(function(){k.update()});this.widget&&this.widget.disable()}},update:function(){if(null!=this.tick){if(this.data&&e.signal(this.data,"update"),this.options.hint.async){var j=++this.tick,f=this;this.options.hint(this.cm,function(k){f.tick==j&&f.finishUpdate(k)},this.options)}else{this.finishUpdate(this.options.hint(this.cm,this.options),j)}}},finishUpdate:function(j){this.data=j;var f=this.widget&&this.widget.picked;this.widget&&this.widget.close();j&&j.list.length&&(f&&1==j.list.length?this.pick(j,0):this.widget=new i(this,j))},showWidget:function(f){this.data=f;this.widget=new i(this,f);e.signal(f,"shown")},buildOptions:function(j){var f=this.cm.options.hintOptions,l={},k;for(k in d){l[k]=d[k]}if(f){for(k in f){void 0!==f[k]&&(l[k]=f[k])}}if(j){for(k in j){void 0!==j[k]&&(l[k]=j[k])}}return l}};i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var f=this.completion.cm;this.completion.options.closeOnUnfocus&&(f.off("blur",this.onBlur),f.off("focus",this.onFocus));f.off("scroll",this.onScroll)}},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var f=this;this.keyMap={Enter:function(){f.picked=!0}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(j,f){j>=this.data.list.length?j=f?this.data.list.length-1:0:0>j&&(j=f?0:this.data.list.length-1);if(this.selectedHint!=j){var k=this.hints.childNodes[this.selectedHint];k.className=k.className.replace(" CodeMirror-hint-active","");k=this.hints.childNodes[this.selectedHint=j];k.className+=" CodeMirror-hint-active";k.offsetTop<this.hints.scrollTop?this.hints.scrollTop=k.offsetTop-3:k.offsetTop+k.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=k.offsetTop+k.offsetHeight-this.hints.clientHeight+3);e.signal(this.data,"select",this.data.list[this.selectedHint],k)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};e.registerHelper("hint","auto",function(j,f){var m=j.getHelpers(j.getCursor(),"hint");if(m.length){for(var k=0;k<m.length;k++){var l=m[k](j,f);if(l&&l.list.length){return l}}}else{if(m=j.getHelper(j.getCursor(),"hintWords")){if(m){return e.hint.fromList(j,{words:m})}}else{if(e.hint.anyword){return e.hint.anyword(j,f)}}}});e.registerHelper("hint","fromList",function(k,j){for(var p=k.getCursor(),n=k.getTokenAt(p),o=[],f=0;f<j.words.length;f++){var l=j.words[f];l.slice(0,n.string.length)==n.string&&o.push(l)}if(o.length){return{list:o,from:e.Pos(p.line,n.start),to:e.Pos(p.line,n.end)}}});e.commands.autocomplete=e.showHint;var d={hint:e.hint.auto,completeSingle:!0,alignWithWord:!0,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:!0,completeOnSingleClick:!1,container:null,customKeys:null,extraKeys:null};e.defineOption("hintOptions",null)});