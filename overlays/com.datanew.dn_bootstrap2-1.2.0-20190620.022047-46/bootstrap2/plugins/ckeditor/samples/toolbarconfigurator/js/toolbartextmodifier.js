(function(){function c(d){a.call(this,d);this.hintContainer=this.codeContainer=null}var a=ToolbarConfigurator.AbstractToolbarModifier,b=ToolbarConfigurator.FullToolbarEditor;ToolbarConfigurator.ToolbarTextModifier=c;c.prototype=Object.create(a.prototype);c.prototype._onInit=function(e,f){a.prototype._onInit.call(this,void 0,f);this._createModifier(f?this.actualConfig:void 0);"function"===typeof e&&e(this.mainContainer)};c.prototype._createModifier=function(h){function m(k){var f=n(k);if(null!==f.charsBetween){var q=i.getUnusedButtonsArray(i.actualConfig.toolbar,!0,f.charsBetween),p=k.getCursor(),f=CodeMirror.Pos(p.line,p.ch-f.charsBetween.length),o=k.getTokenAt(p);"{"===k.getTokenAt({line:p.line,ch:o.start}).string&&(q=["name"]);if(0!==q.length){return new j(f,p,q)}}}function j(e,f,d){this.from=e;this.to=f;this.list=d;this._handlers=[]}function n(f,o){var e={};e.cur=f.getCursor();e.tok=f.getTokenAt(e.cur);e["char"]=o||e.tok.string.charAt(e.tok.string.length-1);var k=f.getRange(CodeMirror.Pos(e.cur.line,0),e.cur).split("").reverse().join(""),k=k.replace(/(['|"]\w*['|"])/g,"");e.charsBetween=k.match(/(^\w*)(['|"])/);e.charsBetween&&(e.endChar=e.charsBetween[2],e.charsBetween=e.charsBetween[1].split("").reverse().join(""));return e}function g(d){setTimeout(function(){d.state.completionActive||CodeMirror.showHint(d,m,{hintsClass:"toolbar-modifier",completeSingle:!1})},100);return CodeMirror.Pass}var i=this;this._createToolbar();this.toolbarContainer&&this.mainContainer.append(this.toolbarContainer);a.prototype._createModifier.call(this);this._setupActualConfig(h);h=this.actualConfig.toolbar;h=CKEDITOR.tools.isArray(h)?"\tconfig.toolbar \x3d "+("[\n\t\t"+b.map(h,function(d){return a.stringifyJSONintoOneLine(d,{addSpaces:!0,noQuotesOnKey:!0,singleQuotes:!0})}).join(",\n\t\t")+"\n\t]")+";":"config.toolbar \x3d [];";h=["CKEDITOR.editorConfig \x3d function( config ) {\n",h,"\n};"].join("");var l=new CKEDITOR.dom.element("div");l.addClass("codemirror-wrapper");this.modifyContainer.append(l);this.codeContainer=CodeMirror(l.$,{mode:{name:"javascript",json:!0},lineNumbers:!1,lineWrapping:!0,viewportMargin:Infinity,value:h,smartIndent:!1,indentWithTabs:!0,indentUnit:4,tabSize:4,theme:"neo",extraKeys:{Left:g,Right:g,"'''":g,"'\"'":g,Backspace:g,Delete:g,"Shift-Tab":"indentLess"}});this.codeContainer.on("endCompletion",function(f,e){var k=n(f);void 0!==e&&f.replaceSelection(k.endChar)});this.codeContainer.on("change",function(){var d=i.codeContainer.getValue(),d=i._evaluateValue(d);null!==d?(i.actualConfig.toolbar=d.toolbar?d.toolbar:i.actualConfig.toolbar,i._fillHintByUnusedElements(),i._refreshEditor(),i.mainContainer.removeClass("invalid")):i.mainContainer.addClass("invalid")});this.hintContainer=new CKEDITOR.dom.element("div");this.hintContainer.addClass("toolbarModifier-hints");this._fillHintByUnusedElements();this.hintContainer.insertBefore(l)};c.prototype._fillHintByUnusedElements=function(){var e=this.getUnusedButtonsArray(this.actualConfig.toolbar,!0),e=this.groupButtonNamesByGroup(e),h=b.map(e,function(f){var d=b.map(f.buttons,function(i){return"\x3ccode\x3e"+i+"\x3c/code\x3e "}).join("");return["\x3cdt\x3e\x3ccode\x3e",f.name,"\x3c/code\x3e\x3c/dt\x3e\x3cdd\x3e",d,"\x3c/dd\x3e"].join("")}).join(" "),g='\x3cdt class\x3d"list-header"\x3eToolbar group\x3c/dt\x3e\x3cdd class\x3d"list-header"\x3eUnused items\x3c/dd\x3e';e.length||(g="\x3cp\x3eAll items are in use.\x3c/p\x3e");this.codeContainer.refresh();this.hintContainer.setHtml("\x3ch3\x3eUnused toolbar items\x3c/h3\x3e\x3cdl\x3e"+g+h+"\x3c/dl\x3e")};c.prototype.getToolbarGroupByButtonName=function(g){var i=this.fullToolbarEditor.buttonNamesByGroup,h;for(h in i){for(var j=i[h],e=j.length;e--;){if(g===j[e]){return h}}}return null};c.prototype.getUnusedButtonsArray=function(e,h,g){h=!0===h?!0:!1;var i=c.mapToolbarCfgToElementsList(e);e=Object.keys(this.fullToolbarEditor.editorInstance.ui.items);e=b.filter(e,function(f){var j="-"===f;f=void 0===g||0===f.toLowerCase().indexOf(g.toLowerCase());return !j&&f});e=b.filter(e,function(d){return -1==CKEDITOR.tools.indexOf(i,d)});h&&e.sort();return e};c.prototype.groupButtonNamesByGroup=function(g){var i=[],h=JSON.parse(JSON.stringify(this.fullToolbarEditor.buttonNamesByGroup)),j;for(j in h){var e=h[j],e=b.filter(e,function(d){return -1!==CKEDITOR.tools.indexOf(g,d)});e.length&&i.push({name:j,buttons:e})}return i};c.mapToolbarCfgToElementsList=function(g){function i(d){return"-"!==d}for(var h=[],j=g.length,e=0;e<j;e+=1){g[e]&&"string"!==typeof g[e]&&(h=h.concat(b.filter(g[e].items,i)))}return h};c.prototype._setupActualConfig=function(d){d=d||this.editorInstance.config;CKEDITOR.tools.isArray(d.toolbar)||(d.toolbarGroups||(d.toolbarGroups=this.fullToolbarEditor.getFullToolbarGroupsConfig(!0)),this._fixGroups(d),d.toolbar=this._mapToolbarGroupsToToolbar(d.toolbarGroups,this.actualConfig.removeButtons),this.actualConfig.toolbar=d.toolbar,this.actualConfig.removeButtons="")};c.prototype._mapToolbarGroupsToToolbar=function(e,h){h=h||this.editorInstance.config.removedBtns;h="string"==typeof h?h.split(","):[];for(var g=e.length;g--;){var i=this._mapToolbarSubgroup(e[g],h);"separator"===e[g].type?e[g]="/":CKEDITOR.tools.isArray(i)&&0===i.length?e.splice(g,1):e[g]="string"==typeof i?i:{name:e[g].name,items:i}}return e};c.prototype._mapToolbarSubgroup=function(i,m){if("string"==typeof i){return i}for(var k=i.groups?i.groups.length:0,n=[],h=0;h<k;h+=1){var l=i.groups[h],l=this.fullToolbarEditor.buttonsByGroup["string"===typeof l?l:l.name]||[],l=this._mapButtonsToButtonsNames(l,m),j=l.length,n=n.concat(l);j&&n.push("-")}"-"==n[n.length-1]&&n.pop();return n};c.prototype._mapButtonsToButtonsNames=function(e,h){for(var g=e.length;g--;){var i=e[g],i="string"===typeof i?i:this.fullToolbarEditor.getCamelCasedButtonName(i.name);-1!==CKEDITOR.tools.indexOf(h,i)?e.splice(g,1):e[g]=i}return e};c.prototype._evaluateValue=function(g){var i;try{var h={};Function("var CKEDITOR \x3d {}; "+g+"; return CKEDITOR;")().editorConfig(h);i=h;for(var j=i.toolbar.length;j--;){i.toolbar[j]||i.toolbar.splice(j,1)}}catch(e){i=null}return i};c.prototype.mapToolbarToToolbarGroups=function(x){function u(f,e){f=f.slice();for(var g=e.length;g--;){var h=f.indexOf(e[g]);-1!==h&&f.splice(h,1)}return f}for(var s={},v=[],w=[],v=x.length,t=0;t<v;t++){if("/"===x[t]){w.push("/")}else{var r=x[t].items,k={};k.name=x[t].name;k.groups=[];for(var o=r.length,i=0;i<o;i++){var j=r[i];if("-"!==j){var q=this.getToolbarGroupByButtonName(j);-1===k.groups.indexOf(q)&&k.groups.push(q);s[q]=s[q]||{};q=s[q].buttons=s[q].buttons||{};q[j]=q[j]||{used:0,origin:k.name};q[j].used++}}w.push(k)}}v=function(h,d){var p=[],n;for(n in h){var m=h[n],l=d[n].slice(),p=p.concat(u(l,Object.keys(m.buttons)))}return p}(s,this.fullToolbarEditor.buttonNamesByGroup);return{toolbarGroups:w,removeButtons:v.join(",")}};return c})();