var Desktop=function(b,a){this.options=a;this.target=$(b);this.deskMain;this.deskBg;this.deskBottom;this.mainMenu;this.deskBtmTab;this.menuTree;this.ztree;this.modPanelHeight=40;this.init()};var oldLeft,oldTop;Desktop.DEFAULTS={systemName:false,showSearchBar:false,showNotice:false,showTodoList:false,showFullscreen:false,showFolder:false,folderConfigs:{title:"图标",width:250,height:200},btmBaseInfo:'<span><i class="glyphicon glyphicon-time"></i>&nbsp;今天是<b class="today"></b></span>',windowFullscreen:false,windowSizeArea:["50%","50%"],fixedMenu:false,deskBtmPos:"bottom",dopenResize:true,leaveTip:false,contextMenu:false,shortTextLen:18,defaultIcon:String($.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/icon_default.png"),dragOptions:{containment:".deskMain",scroll:false,grid:[100,100],start:function(a,b){oldLeft=$(a.target).css("left");oldTop=$(a.target).css("top")},drag:function(a,g){var f=$(a.target),b=g.position,h=b.top,e=b.left,c=$(".desk_trash").position(),d=c.top,i=c.left;if(h>=d&&h<=d+20&&e>=i&&e<=i+20){f.addClass("desk_del_mask")}else{f.removeClass("desk_del_mask")}},stop:function(a,j){var i=$(a.target),e=j.position,k=e.top,h=e.left,f=$(".desk_trash").position(),g=f.top,l=f.left,d=i.parents(".deskMain").parent().data("desktop");if(k>=g&&k<=g+20&&h>=l&&h<=l+20){i.remove()}var c=i.data("id");$(".deskItem[data-drag='draggable']").each(function(o){var m=$(this).data("id");if(c!==m){var n=parseInt($(this).css("left"));var p=parseInt($(this).css("top"));if(n===e.left&&p===e.top){i.css({left:oldLeft,top:oldTop})}}});var b=$(".desk_folder");if(b.length>0){$.each(b,function(p){var q=$(this),o=q.width(),m=q.height(),s=q.position().left,r=q.position().top,n=q.find(".folderBox");if(k>=r&&k<=(r+m)&&(h+i.outerWidth())>=s&&h<=(s+o)){i.appendTo(n).css({position:"static",left:"auto",top:"auto"})}})}d.saveDesktop()}},module_dragOptions:{containment:".deskMain",scroll:false,grid:[10,10],stop:function(a,c){var d=$(a.target),b=d.parents(".deskMain").parent().data("desktop");b.saveDesktop()}},checkType:"nocheck",view:{showLine:false,dblClickExpand:false},data:{key:{durl:"url"}},callback:{},onDeskLoaded:function(a){}};Desktop.prototype.init=function(){this.initDeskMain();this.initDeskBottom();this.initMenuTree()};Desktop.prototype.initDeskMain=function(){var options=this.options,target=this.target,that=this,systemName_html="",searchBar_html="";if(options.systemName!==false){systemName_html='<div class="systemName" data-drag="draggable">'+options.systemName+"</div>"}if(options.showSearchBar){searchBar_html='<div class="desk_module desk_searchBar" data-drag="draggable" data-type="deskModule"><input type="text" class="s_inp pull-left" placeholder="请输入搜索内容" /><button type="button" class="s_btn pull-right"><i class="glyphicon glyphicon-search"></i></button></div>'}var deskHtml='<div class="deskMain"><div class="deskBg">'+systemName_html+searchBar_html+'    <div class="deskItem desk_trash">        <div class="item-trash"><i class="glyphicon glyphicon-trash"></i></div>        <p class="textover-ell item-txt">回收站</p>    </div></div></div><div class="deskBottom clearfix">    <div class="pull-left showMenu"></div>    <div class="pull-left">        <ul class="deskBtmTab clearfix"></ul>    </div>    <div class="pull-right systemInfo clearfix">        <div class="pull-right btmMenus btn-group dropup">            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">                <span class="caret"></span>            </button>            <ul class="dropdown-menu dropdown-menu-right btmDropMenu"></ul>        </div>        <div class="pull-right baseInfo">'+options.btmBaseInfo+'</div>    </div></div><div class="mainMenu">    <ul class="menuTree"></ul></div>';target.append(deskHtml).css({position:"relative",width:"100%",height:"100%"});if($.plugMiniConfig){target.addClass("miniDesktop")}$("body, *").on("contextmenu",function(){return false}).on("selectstart",function(){return false});that.deskMain=target.find(".deskMain");that.deskBg=that.deskMain.find(".deskBg");that.deskBottom=target.find(".deskBottom");that.deskBtmTab=target.find(".deskBtmTab");that.mainMenu=target.find(".mainMenu");that.menuTree=target.find(".menuTree");if(options.systemName!==false){var desk_trash=that.deskBg.find(".desk_trash");desk_trash.css({top:"70px"});that.trashTop=70}else{that.trashTop=0}target.find(".showMenu").on("click",function(){if(that.mainMenu.is(":hidden")){that.mainMenu.slideDown(200).addClass("topZIndex");$(document).mouseup(function(e){if(!that.mainMenu.is(e.target)&&that.mainMenu.has(e.target).length===0){that.hideMainMenu()}})}else{that.hideMainMenu()}});if(options.fixedMenu){target.addClass("fixedMenu").find(".showMenu").remove()}that.target.addClass("btmPos_"+options.deskBtmPos);that.deskBtmTab.removeClass("btmPos_side");if(options.deskBtmPos==="top"){that.deskBottom.find(".btmMenus").removeClass("dropup").addClass("dropdown")}else{if(options.deskBtmPos==="left"){that.deskBtmTab.addClass("btmPos_side");that.deskBottom.find(".btmMenus .dropdown-menu").css({left:"40px"})}else{if(options.deskBtmPos==="right"){that.deskBtmTab.addClass("btmPos_side");that.deskBottom.find(".btmMenus .dropdown-menu").css({right:"40px"})}}}that.deskBottom.find(".btmMenus").on("show.bs.dropdown",function(){that.deskBottom.addClass("topZIndex")}).on("hide.bs.dropdown",function(){that.deskBottom.removeClass("topZIndex")});that.deskMain.on("click",function(e){var theEvent=window.event||arguments.callee.caller.arguments[0],clickObj=theEvent.srcElement?$(theEvent.srcElement):$(theEvent.target),targetClass=clickObj.attr("class");if(targetClass.indexOf("deskItem")===-1&&!clickObj.parent().is(".deskItem")){that.setItemActive(false)}}).on("dblclick",".desk_icon",function(){that.openWindow(this)}).on("click",".desk_icon",function(){that.setItemActive()});$("body").on("mousedown",function(){that.deskBg=that.deskMain.find(".deskBg");that.deskBg.on("contextmenu",".desk_icon",function(e){var thisIcon=$(this);that.setItemActive();var menu=[["重命名",function(){var text_area=thisIcon.find(".item-txt"),text_txt=text_area.text(),text_inp=$('<textarea class="txt-inp"></textarea>');text_area.html(text_inp.text(text_txt));text_inp.select().on("blur",function(){var newTxt=text_inp.val();text_area.html(newTxt);thisIcon.attr("title",newTxt);that.saveDesktop()})}],["删除快捷方式",function(){thisIcon.remove();that.saveDesktop()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/close.gif)"]];ContextMenu.render(e,menu,this,"special");return false}).on("contextmenu",".desk_module:not(.desk_folder):not(.desk_iframe)",function(e){var thisIcon=$(this);var menu=[["删除快捷方式",function(){thisIcon.remove();that.saveDesktop()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/close.gif)"]];ContextMenu.render(e,menu,this,"special");return false}).on("contextmenu",".desk_folder",function(e){var thisIcon=$(this),thisHeading=thisIcon.find(".panel-heading"),thisBody=thisIcon.find(".panel-body");var menu=[["修改",function(){$.dopen({title:"修改",content:'<form class="updateFolder"></form>',area:["300px","200px"],maxmin:false,btn:["确定","取消"],btn1:function(index){var formData=$(".updateFolder").dform("getData");thisIcon.width(formData.width);thisHeading.html(formData.title);thisBody.height(formData.height-that.modPanelHeight);layer.close(index);that.saveDesktop()}});$(".updateFolder").dform({rownum:1,labelwidth:"100px",inputs:[{title:"标题",name:"title",type:"textBox",defaultValue:thisHeading.text()},{title:"容器宽度",name:"width",type:"textBox",defaultValue:thisIcon.width()},{title:"容器高度",name:"height",type:"textBox",defaultValue:thisBody.height()+that.modPanelHeight}]})}],["删除桌面文件夹",function(){thisIcon.remove();that.saveDesktop()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/close.gif)"]];ContextMenu.render(e,menu,this,"special");return false})});options.dragOptions.containment=that.deskMain;$(".desk_icon[data-drag='draggable']").draggable(options.dragOptions);$(".systemName, .desk_searchBar").css({position:"absolute"}).draggable(options.module_dragOptions);if(options.leaveTip){$(window).bind("beforeunload",function(){return"您输入的内容尚未保存，确定离开此页面吗？"})}if(options.contextMenu){var menuItem=[],newMenu=[],updateTableData=[],menu=["|",["修改自定义菜单项",function(){$.dopen({title:"修改",content:'<table id="updateMenuTable"></table>',area:["600px","400px"],maxmin:false,btn:["关闭"],btn1:function(index){$("#updateMenuTable").tableEditor("updateAll");updateTableData=$("#updateMenuTable").dtable("getData");newMenu.splice(0,newMenu.length);$.each(updateTableData,function(key,val){menuItem=[val.menuTitle,function(){val.menuFunc=$.trim(val.menuFunc);if(val.menuFunc!=""&&val.menuFunc!=undefined){if(val.menuFunc.indexOf("()")===-1){eval(val.menuFunc+"()")}else{eval(val.menuFunc)}}}];newMenu.push(menuItem)});layer.close(index)}});var tableObj=$("#updateMenuTable");tableObj.dtable({height:300,columns:[{field:"menuCheck",checkbox:true,width:20},{field:"menuTitle",title:"菜单项名称",width:"100",align:"center",editor:{type:"textBox",name:"textBox"}},{field:"menuFunc",title:"菜单项点击事件",width:"100",align:"center",editor:{type:"textBox",name:"textBox"}}],data:updateTableData,showRefresh:false,clickToSelect:true,toolbar:[{name:"新增",classes:"btn bootstrap-table-add addMenu",type:"button"},{name:"删除",classes:"btn bootstrap-table-delete delMenu",type:"button"}]});tableObj.tableEditor("initAll");var $bootstrapTable=tableObj.parents(".bootstrap-table");$bootstrapTable.find(".addMenu").on("click",function(){var tableData=tableObj.dtable("getData"),dataLen=tableData.length;tableObj.tableEditor("update",dataLen-1);tableObj.dtable("insertRow",{index:dataLen,row:{}});tableObj.tableEditor("initAll");layer.msg("新增成功",{time:500})});$bootstrapTable.find(".delMenu").on("click",function(){var tableData=tableObj.dtable("getData"),selectData=tableObj.dtable("getSelections");if(selectData.length>0){$.each(selectData,function(k,v){var selectIndex=tableData.indexOf(selectData[k]);tableObj.dtable("removeByRowIndex",selectIndex)});updateTableData=tableObj.dtable("getData");tableObj.dtable("load",updateTableData);tableObj.tableEditor("initAll");layer.msg("删除成功",{time:500})}})}],["新增桌面文件夹",function(){that.addFolder()}],"|",["关闭所有窗口",function(){layer.closeAll()}],"|",["主题设置",function(e){updateTheme()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/desktop_setting.gif)"],["刷新页面",function(e){location.reload()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/refresh.gif)"]];$("body").on("mousedown",function(){that.deskBg=that.deskMain.find(".deskBg");that.deskBg.on("contextmenu",function(e){var menu2;if(newMenu.length>0){menu2=newMenu.concat(menu);ContextMenu.render(e,menu2,this,"special")}else{ContextMenu.render(e,menu,this,"special")}})});that.deskBg.on("contextmenu",".desk_trash, .desk_iframe",function(e){ContextMenu.render(e,true,this)});function updateTheme(){that.deskBg=that.deskMain.find(".deskBg");if($(".wallpaper").length===0){$.dopen({title:"主题设置",maxmin:false,content:'<div class="wallpaperstyle">显示方式：<input id="select" /></div><ul class="wallpaper clearfix"></ul>',area:["720px","480px"]});$(".wallpaper").append(function(index,html){var liHtml="";for(var i=1;i<=9;i++){var jpgImg=$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/s-bg/s_wallpaper"+i+".jpg";liHtml+='<li wpid="'+i+'"><img src="'+jpgImg+'"><div>壁纸'+i+"</div></li>"}return liHtml});$("#select").comboBox({selected:1,width:100,required:true,multiple:false,localdata:[{id:1,text:"拉伸"},{id:2,text:"适应"},{id:3,text:"平铺"},{id:4,text:"充填"}],onChange:function(newValue,oldValue,optionObj){if(newValue=="1"){that.deskBg.css({"background-size":"100% 100%"})}else{if(newValue=="2"){that.deskBg.css({"background-size":"contain","background-position":"center"})}else{if(newValue=="3"){that.deskBg.css({"background-size":"cover"})}else{if(newValue=="4"){that.deskBg.css({"background-size":"120%","background-position":"center"})}}}}}})}}$("body").on("click",".wallpaper li",function(){that.deskBg=that.deskMain.find(".deskBg");that.deskBg.css("background-image","url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/bg/wallpaper"+$(this).attr("wpid")+".jpg)")})}if(options.showFullscreen){var systemInfo=target.find(".systemInfo");systemInfo.prepend('<div class="pull-right fullscreen"><i class="glyphicon glyphicon-fullscreen"></i></div>');systemInfo.find(".fullscreen").click(function(){if(!isFullScreen()){requestFullScreen()}else{exitFullScreen()}});function isIE(){return !!window.ActiveXObject||"ActiveXObject" in window}function requestFullScreen(){var element=isIE()?document.body:document.documentElement;if(element.requestFullscreen){element.requestFullscreen()}else{if(element.mozRequestFullScreen){element.mozRequestFullScreen()}else{if(element.webkitRequestFullScreen){element.webkitRequestFullScreen()}else{if(element.msRequestFullscreen){element.msRequestFullscreen()}else{if(typeof window.ActiveXObject!=="undefined"){var wscript=new ActiveXObject("WScript.Shell");if(wscript!==null){wscript.SendKeys("{F11}")}}}}}}}function exitFullScreen(){if(document.exitFullscreen){document.exitFullscreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitExitFullscreen){document.webkitExitFullscreen()}else{if(document.msExitFullscreen){document.msExitFullscreen()}else{if(typeof window.ActiveXObject!=="undefined"){var wscript=new ActiveXObject("WScript.Shell");if(wscript!==null){wscript.SendKeys("{F11}")}}}}}}}function isFullScreen(){return !!(document.webkitIsFullScreen||document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.mozFullScreenElement||null)}}if(options.showNotice){var deskNotice=$('<div class="desk_module desk_notice" data-drag="draggable" data-type="deskModule">    <div class="panel">        <div class="panel-heading"><i class="module_icon module_icon-1"></i>通知公告 <span class="badge">2</span> <a href="" class="module_all pull-right" target="_blank">全部通知</a></div>        <div class="panel-body">            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">                <!-- Indicators -->                <ol class="carousel-indicators carouselDot">                    <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>                    <li data-target="#carousel-example-generic" data-slide-to="1"></li>                   <li data-target="#carousel-example-generic" data-slide-to="2"></li>                </ol>                <!-- Wrapper for slides -->                <div class="carousel-inner" role="listbox">                    <div class="item active">                        <div class="notice-title clearfix"><a href="" target="_blank"><b>关于五一放假的通知</b></a></div>                        <div class="notice-txt">五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排：五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排</div>                        <div class="notice-date text-right">4月20日&emsp; From 办公室</div>                    </div>                    <div class="item">                        <div class="notice-title clearfix"><a href="" target="_blank"><b>关于五一放假的通知</b></a></div>                        <div class="notice-txt">五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排：五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排</div>                        <div class="notice-date text-right">4月20日&emsp; From 办公室</div>                    </div>                    <div class="item">                        <div class="notice-title clearfix"><a href="" target="_blank"><b>关于五一放假的通知</b></a></div>                        <div class="notice-txt">五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排：五一劳动节即将来临，根据公司的实际情况，现对2018年五一劳动节放假做如下安排</div>                        <div class="notice-date text-right">4月20日&emsp; From 办公室</div>                    </div>                </div>                <!-- Controls -->                <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">                    <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span>                    <span class="sr-only">Previous</span>                </a>                <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">                    <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>                    <span class="sr-only">Next</span>                </a>            </div>        </div>    </div></div>');that.deskBg.append(deskNotice);deskNotice.css({position:"absolute"}).draggable(options.module_dragOptions)}if(options.showTodoList){var deskTodoList=$('<div class="desk_module desk_todolist" data-drag="draggable" data-type="deskModule">    <div class="panel">        <div class="panel-heading"><i class="module_icon module_icon-2"></i>待办事项 <a href="" class="module_all pull-right" target="_blank">全部待办</a></div>        <ul class="panel-body list-group">            <li class="list-group-item clearfix">                <a href="" class="pull-left textover-ell list-title" target="_blank">关于组织架构的调整</a>                <span class="pull-right list-time">17分钟前</span>                <span class="pull-right list-user">人力资源</span>            </li>            <li class="list-group-item clearfix">                <a href="" class="pull-left textover-ell list-title" target="_blank">近期项目进度总结汇报总结汇报总结汇报</a>                <span class="pull-right list-time">3月30日</span>                <span class="pull-right list-user">开发组</span>            </li>        </ul>    </div></div>');that.deskBg.append(deskTodoList);deskTodoList.css({position:"absolute"}).draggable(options.module_dragOptions)}};Desktop.prototype.initDeskBottom=function(){var b=this,a=b.deskBtmTab,c=b.deskBottom;b.target.find(".today").html(b.getToday());a.on("click","li",function(){var f=$(this).attr("data-layerId");var e=$("#"+f);var d=b.arrSort()+1;if(e.is(":hidden")){e.show().css({zIndex:d+1}).attr("data-zindex",d+1);$(this).addClass("tabActive").siblings().removeClass("tabActive")}else{if(!$(this).hasClass("tabActive")){if(d!==parseInt($(this).attr("data-zindex"))){e.css({zIndex:d+1}).attr("data-zindex",d+1);$(this).addClass("tabActive").siblings().removeClass("tabActive")}}else{if($(this).hasClass("tabActive")){e.hide();$(this).removeClass("tabActive")}}}});a.on("contextmenu","li",function(f){var d=$(this).attr("data-layerIndex");var g=[["关闭窗口",function(){layer.close(d)},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/close.gif)"]];ContextMenu.render(f,g,this,"special");return false});c.on("contextmenu",function(d){if(a.find(".btmTab_item").length>0){var f=[["关闭所有窗口",function(){layer.closeAll()},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/close.gif)"],["显示桌面",function(){$(".layui-layer").each(function(){$(this).hide();a.find("li").removeClass("tabActive")})}]];ContextMenu.render(d,f,this,"special")}});b.btmMenuData=[{menuIcon:"glyphicon-log-out",menuTitle:"退出",menuFunc:"/"},{menuIcon:"glyphicon-lock",menuTitle:"修改密码",menuFunc:"updatePassword"}];b.initBtmMenu(b.btmMenuData)};Desktop.prototype.initBtmMenu=function(menuObj){var that=this,deskBottom=that.deskBottom,btmDropMenu=deskBottom.find(".btmDropMenu");btmDropMenu.empty();$.each(menuObj,function(key,val){var logout=val.menuTitle==="退出"?(that.options.loginOutUrl!==undefined?that.options.loginOutUrl:"javascript:void(0);"):"javascript:void(0);";var item=$('<li><a href="'+logout+'"><i class="glyphicon '+val.menuIcon+'"></i>'+val.menuTitle+"</a></li>");btmDropMenu.prepend(item);val.menuFunc=$.trim(val.menuFunc);if(val.menuFunc!=""&&val.menuFunc!=undefined){if(val.menuFunc.indexOf("()")===-1){item.on("click",function(){eval(val.menuFunc+"()")})}else{item.on("click",function(){eval(val.menuFunc)})}}})};Desktop.prototype.initMenuTree=function(){var b=this.options,c=this;b.callback.clickNode=function(j,i,h,g){var f=c.ztree;if(!!h[f.setting.data.key.children]){f.expandNode(h)}if(!!h[f.setting.data.key.durl]){c.openWindow(h);c.hideMainMenu()}};b.callback.onNodeCreated=function(h,g,f){if(!!f[b.data.key.durl]){$("#"+f.tId+"_a").on("contextmenu",function(i){var j=[["创建快捷方式",function(){c.createShortcut(f)},"url("+$.getRootPath()+"/"+__bootstrapVersionPath+"/plugins/desktop/images/contextmenu/add.gif)"]];ContextMenu.render(i,j,this,"special");return false})}};var d=c.menuTree.attr("id")!=null?c.menuTree.attr("id"):"ztree_"+new Date().getTime();c.menuTree.attr({id:d});if(!!b.url){$.dajax({url:b.url,data:b.queryParam,async:false,success:function(e){c.datas=e;b.localdata=e;b.url="";a()}})}else{a()}function a(){c.menuTree.tree(b);c.ztree=c.menuTree.tree("getTree")}};Desktop.prototype.addFolder=function(){var d=this,b=d.options,c=d.deskMain.find(".deskBg"),a=b.folderConfigs;var e=$('<div class="desk_module desk_folder" data-drag="draggable" data-type="deskModule"><div class="panel"><div class="panel-heading">'+a.title+'</div><div class="panel-body"><div class="folderBox clearfix"> </div></div></div></div>');c.append(e);e.width(a.width).css({position:"absolute",left:(d.deskMain.width()-a.width)/2,top:0}).find(".panel-body").height(a.height-d.modPanelHeight);e.draggable(b.module_dragOptions);e.draggable("option","handle",".panel-heading")};Desktop.prototype.saveDesktop=function(){var options=this.options,func=options.saveDesktopFunc;if(func!==undefined){if(typeof func==="string"){eval(func+"()")}else{if(typeof func==="function"){func.call(this)}}}};Desktop.prototype.createShortcut=function(f){var k=this,j=k.options.defaultIcon,p=k.options.dragOptions,g=k.deskMain,n=g.find(".deskBg"),a=k.menuTree,e=k.ztree;var b=[];$(".deskItem").each(function(s){var u=$(this);var r=parseInt(u.css("left"));var t=parseInt(u.css("top"));b.push({left:r,top:t})});var i=Math.ceil(g.width()/100);var d=Math.ceil((g.height()-k.trashTop)/100);if(i*100-g.width()>20){i=i-1}if(d*100-(g.height()-k.trashTop)>30){d=d-1}if(b.length>=i*d){$.dalert({text:"桌面快捷方式已满，无法添加",icon:2});return false}var q=f[e.setting.data.key.icon],c=(q===undefined||q==null||q==="")?j:q;if($(".desk_icon[data-id='"+f[e.setting.data.simpleData.idKey]+"']").length===0){var m=k.setItemPos(b,i,d);var l=f[e.setting.data.key.name],h=k.getSubString(l);var o='<div class="deskItem desk_icon" title="'+l+'" data-drag="draggable" data-type="deskIcon" data-id="'+f[e.setting.data.simpleData.idKey]+'" data-url="'+f[e.setting.data.key.durl]+'"><img src="'+c+'" class="item-img" alt=""/><span class="badge item-badge"></span><p class="item-txt">'+h+"</p></div>";$(o).appendTo(n).css(m);$(".desk_icon").last().draggable(p)}else{$.dalert({text:"该快捷方式已创建",icon:7})}k.hideMainMenu();k.saveDesktop()};Desktop.prototype.setItemActive=function(d){var f=this,h=f.deskBg;if(d===false){var c=h.data("newSelect");$(".deskItem[data-id="+c+"]").removeClass("deskItemActive").find("p").text(f.getSubString(a(c)));return false}if(h.data("newSelect")!==undefined){h.data("oldSelect",h.data("newSelect"))}var e=window.event||arguments.callee.caller.arguments[0],j=e.srcElement?$(e.srcElement):$(e.target),g;if(j.parent().is(".deskItem")){g=j.parent()}else{g=j}var i=a(g.data("id")),b=a(h.data("oldSelect"));h.data("newSelect",g.data("id"));g.addClass("deskItemActive").find("p").text(i).end().siblings().removeClass("deskItemActive").end().siblings(".deskItem[data-id="+h.data("oldSelect")+"]").find("p").text(f.getSubString(b));f.stopBubble(e);function a(n){var l=f.menuTree.tree("getTree").setting,k=f.getAllShortcut(),m="";$.each(k,function(o){if(n==k[o].id){m=k[o].name;return false}});return m}};Desktop.prototype.setItemPos=function(c,a,k){var b=[],d=this.trashTop;for(var g=0;g<a;g++){for(var f=0;f<k;f++){b.push({left:g*100,top:f*100+d})}}for(var e=0;e<a;e++){for(var l=0;l<k;l++){$.each(c,function(i,j){if(j.left===e*100&&j.top===l*100+d){delete b[e*k+l];return true}})}}var h;$.each(b,function(i){if(b[i]!=undefined||b[i]!=null){h=b[i];return false}});return h};Desktop.prototype.showDeskIcon=function(){var g=this,f=g.deskMain,b=f.find(".deskItem"),i=b.length;var c=100,d=100;var a=Math.round(f.height()/d),h=0,e=Math.ceil(i/a);$.each(b,function(j){$(this).css({position:"absolute",left:c*h,top:d*(j%a)});if((j+1)%a===0&&j!==0){h++}})};Desktop.prototype.openWindow=function(n){var i=this,d=i.options,p=i.deskMain,c=p.find(".deskBg"),y=i.deskBottom,q=i.deskBtmTab,E=i.options.defaultIcon,A=i.ztree;var s,m,b,C;if(n.nodeType===1){s=$(n).attr("data-id");m=$(n).attr("data-url");b=$(n).find(".item-img").attr("src");C=$(n).find(".item-txt").text()}else{var l=n[A.setting.data.key.icon];s=n[A.setting.data.simpleData.idKey];m=n[A.setting.data.key.durl];b=(l===undefined||l==null||l==="")?E:l;C=n[A.setting.data.key.name]}var D="<img src='"+b+"' /><span>"+C+"</span>",j;var r=a(d.windowSizeArea),w=d.windowFullscreen?["100%",$(window).height()-y.height()+"px"]:r,B=p.outerWidth(true),e=$(window).height()-y.height(),o=$(".layui-layer").last(),g=[],x=[];function a(F){var G=[];if(F[0].indexOf("%")!==-1){G[0]=(parseInt(F[0])/100)*p.outerWidth(true)+"px"}else{G[0]=F[0]}if(F[1].indexOf("%")!==-1){G[1]=(parseInt(F[1])/100)*p.outerHeight(true)+"px"}else{G[1]=F[1]}return G}if(o.length===0){g=["1%","1%"]}else{if(o.length>0){g=[parseInt(o.css("top"))+30+"px",parseInt(o.css("left"))+30+"px"]}}var f={type:2,title:"<div class='windowTit'>"+D+"</div>",area:w,content:m,shade:0,resize:d.dopenResize,offset:d.windowFullscreen?"t":g,moveStart:function(H){var G=$("[data-layerid='"+H.attr("id")+"']");var F=i.arrSort()+1;if(!G.hasClass("tabActive")){if(F!==parseInt(G.attr("data-zindex"))){H.css({zIndex:F+1}).attr("data-zindex",F+1);G.addClass("tabActive").siblings().removeClass("tabActive")}}},moveEnd:function(F){x=[F.css("top"),F.css("left")]},success:function(K,I){j=K.attr("id");if($(".btmTab_item[data-layerId="+j+"]").length===0){var M="<li class='btmTab_item tabActive' data-layerId='"+j+"' data-layerIndex='"+I+"'>"+D+"</li>";q.find("li").removeClass("tabActive");q.append(M);var L=i.arrSort()+1;K.css({zIndex:L}).attr({"data-zindex":K.css("z-index"),"data-id":s});var H=y.width()-$(".showMenu").outerWidth()-$(".systemInfo").outerWidth();if(navigator.userAgent.indexOf("MSIE")>0&&(navigator.userAgent.indexOf("MSIE 6.0")>0||navigator.userAgent.indexOf("MSIE 7.0")>0||navigator.userAgent.indexOf("MSIE 8.0")>0)){H=H-50}var F=0;q=i.deskBtmTab;$.each(q.find("li"),function(){F+=$(this).outerWidth()});if(F>=H){q.css("max-width",H);var J=q.find("li").length;q.find("li").width(Math.floor(H/J)-30)}var G=$("#layui-layer-iframe"+I),N=$("body",G[0].contentWindow.document);N.on("click",function(){i.hideMainMenu()})}},resizing:function(F){z(F)},min:function(F){F.hide();q.find("[data-layerId="+j+"]").removeClass("tabActive");F.data("fullscreen",false);return false},full:function(F){u(F,"full");z(F);F.data("fullscreen",true)},restore:function(G){var F=G.prev(".layui-layer");if(F.length===0){x=["1%","1%"]}else{x=[parseInt(F.css("top"))+30+"px",parseInt(F.css("left"))+30+"px"]}u(G,"restore");z(G);G.data("fullscreen",false)},end:function(){q.find("[data-layerId="+j+"]").remove();x.splice(0,x.length)}};var k=$(".layui-layer[data-id='"+s+"']");if(k.length===0){var h=$.dopen(f);k=$("#layui-layer"+h);$(window).resize(function(){if(k.data("fullscreen")){u(k,"full")}else{u(k,"restore")}});if(d.windowFullscreen){layer.full(h);setTimeout(function(){u(k,"full");k.data("fullscreen",true)},100)}}else{var v=i.arrSort()+1;k.show().css({zIndex:v}).attr({"data-zindex":k.css("z-index")})}function u(H,G){if(G==="full"){var F=p.outerHeight(true);H.css({top:0,left:0,width:"100%",height:F});H.find(".layui-layer-min").show()}else{if(G==="restore"){H.css({top:x[0],left:x[1],width:r[0],height:r[1]})}}t(H)}function t(F){var G=F.outerHeight()-F.find(".layui-layer-title").outerHeight()-5;F.find("iframe").css("height",G)}function z(F){var G=F.find("iframe")[0].contentWindow;if(!!G.resetLayerTableView){G.resetLayerTableView()}}};Desktop.prototype.getToday=function(){var b=new Date();var c=b.getFullYear();var d=b.getMonth()+1;var a=b.getDate();return c+"年"+d+"月"+a+"日"};Desktop.prototype.stopBubble=function(a){if(a&&a.stopPropagation){a.stopPropagation()}else{window.event.cancelBubble=true}};Desktop.prototype.getStrLen=function(b){var a=/[^\x00-\xff]/g;return b.replace(a,"aa").length};Desktop.prototype.getSubString=function(g,b,c){var f=this;if(b===undefined){b=f.options.shortTextLen}if(c===undefined){c="..."}if(f.getStrLen(g)<=b){return g}var a=Math.floor(b/2);for(var e=a,d=g.length;e<d;e++){if(f.getStrLen(g.substring(0,e))>=b){g=g.substring(0,e)}}return g+c};Desktop.prototype.arrSort=function(){var a=[];$(".layui-layer").each(function(){a.push(parseInt($(this).attr("data-zindex")))});a.sort(function(d,c){return c-d});return a[0]};Desktop.prototype.hideMainMenu=function(){if(!this.options.fixedMenu){this.mainMenu.fadeOut(10).removeClass("topZIndex")}};Desktop.prototype.addBtmMenu=function(a){var b=this;b.btmMenuData.push(a);b.initBtmMenu(b.btmMenuData)};Desktop.prototype.addWindow=function(a){var i=this,o=i.options,g=i.deskMain,d=i.deskBottom,b=i.deskBtmTab,h=i.options.defaultIcon,e,c=a.id,n="<img src='"+h+"' /><span>"+a.title+"</span>";var m={shade:0,resize:o.dopenResize,moveStart:function(r){var q=$("[data-layerid='"+r.attr("id")+"']");var p=i.arrSort()+1;if(!q.hasClass("tabActive")){if(p!==parseInt(q.attr("data-zindex"))){r.css({zIndex:p+1}).attr("data-zindex",p+1);q.addClass("tabActive").siblings().removeClass("tabActive")}}},success:function(u,s){e=u.attr("id");if($(".btmTab_item[data-layerId="+e+"]").length===0){var w="<li class='btmTab_item tabActive' data-layerId='"+e+"' data-layerIndex='"+s+"'>"+n+"</li>";b.find("li").removeClass("tabActive");b.append(w);var v=i.arrSort()+1;u.css({zIndex:v}).attr({"data-zindex":u.css("z-index"),"data-id":c});var r=d.width()-$(".showMenu").outerWidth()-$(".systemInfo").outerWidth();if(navigator.userAgent.indexOf("MSIE")>0&&(navigator.userAgent.indexOf("MSIE 6.0")>0||navigator.userAgent.indexOf("MSIE 7.0")>0||navigator.userAgent.indexOf("MSIE 8.0")>0)){r=r-50}var p=0;b=i.deskBtmTab;$.each(b.find("li"),function(){p+=$(this).outerWidth()});if(p>=r){b.css("max-width",r);var t=b.find("li").length;b.find("li").width(Math.floor(r/t)-30)}if(a.type==2){var q=$("#layui-layer-iframe"+s),x=$("body",q[0].contentWindow.document);x.on("click",function(){i.hideMainMenu()})}}},resizing:function(p){f(p)},min:function(p){p.hide();b.find("[data-layerId="+e+"]").removeClass("tabActive");return false},full:function(p){var q=g.outerHeight(true);p.css({top:0,left:0,width:"100%",height:q});p.find(".layui-layer-min").show();k(p);f(p)},end:function(){b.find("[data-layerId="+e+"]").remove()}};var j=$(".layui-layer[data-id='"+c+"']");if(j.length===0){a=$.extend({},m,a);$.dopen(a)}else{var l=i.arrSort()+1;j.show().css({zIndex:l}).attr({"data-zindex":j.css("z-index")})}function k(p){var q=p.outerHeight()-p.find(".layui-layer-title").outerHeight()-5;p.find(".layui-layer-content").height(q);if(a.type==2){p.find("iframe").css("height",q)}}function f(p){if(a.type==2){var q=p.find("iframe")[0].contentWindow;if(!!q.resetLayerTableView){q.resetLayerTableView()}}}};Desktop.prototype.addIframe=function(e){var g=this,l=g.options,f=g.options.defaultIcon,c=$(".desk_iframe").length+1,j=g.deskMain.find(".deskBg"),b="";if(e.src!==undefined&&e.src!==""){b='<iframe src="'+e.src+'" frameborder="0" width="100%" height="100%"></iframe>'}else{if(e.html!==undefined){b=e.html}}var h=$('<div class="desk_module desk_iframe" data-drag="draggable" data-type="deskModule"><div class="panel"><div class="panel-heading"><img src="'+((e.icon===""||e.icon===undefined)?f:e.icon)+'" class="module_icon_img" />'+e.title+'<div class="module_btns clearfix"></div></div><div id="iframe_collapse-'+c+'" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="iframe_heading-'+c+'"><div class="panel-body">'+b+"</div></div></div></div>");j.append(h);h.css({position:"absolute",width:e.width,height:e.height,left:e.left,right:e.right,top:e.top,bottom:e.bottom}).draggable(l.module_dragOptions);h.find(".panel-body").css({height:e.height-g.modPanelHeight});h.find(".panel-heading").on("mousedown",function(){j.find(".desk_module").removeClass("active");h.addClass("active")});if(e.rightTopLink!==undefined){h.find(".module_btns").append(e.rightTopLink)}if(e.isCollapse){var k=$('<i class="btn-collapse glyphicon glyphicon-chevron-up"  id="iframe_heading-'+c+'" data-toggle="" data-parent="#accordion" href="#iframe_collapse-'+c+'" aria-expanded="true" aria-controls="iframe_collapse-'+c+'"></i>');h.find(".module_btns").append(k).end().find(".btn-collapse").attr("data-toggle","collapse").end().on("hide.bs.collapse",function(){k.addClass("rotate-icon");h.height(g.modPanelHeight)}).on("show.bs.collapse",function(){k.removeClass("rotate-icon");h.height(e.height)})}if(e.isClose){var i=$('<i class="btn-close glyphicon glyphicon-remove"></i>');h.find(".module_btns").append(i);i.on("click",a)}function a(){h.remove();g.saveDesktop()}var d=layer.load(1,{shade:0,time:1000});h.draggable("option","handle",".panel-heading")};Desktop.prototype.addShortcut=function(a){this.createShortcut(a)};Desktop.prototype.removeShortcut=function(b){var a=this.deskMain;a.find(".deskItem[data-id="+b+"]").remove()};Desktop.prototype.getAllShortcut=function(){var a=this,b=a.target,c=[];b.find(".desk_icon").each(function(d){var e=$(this);c.push({id:parseInt(e.attr("data-id")),url:e.attr("data-url"),name:e.prop("title"),icon:e.find(".item-img").attr("src"),left:parseInt(e.css("left")),top:parseInt(e.css("top"))})});return c};